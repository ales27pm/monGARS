# monGARS Package Contract

> ⚠️ Auto-generated by `scripts/manage_agents.py`. Update `configs/agents/agents_config.json` and rerun the script instead of editing this file manually.

## Scope

Covers the primary FastAPI app, cognition services, persistence layer, and shared utilities.

## Automation

- Edit `configs/agents/agents_config.json` then run `python scripts/manage_agents.py refresh` to regenerate charters.
- CI reruns the refresh and publishes `docs_metadata.patch` on drift—apply it with `git apply docs_metadata.patch`.

## Roadmap Alignment

- **Runtime & Performance**
  - ✅ Worker auto-tuning for Pi/Jetson (`recommended_worker_count`).
  - ✅ Multi-architecture build scripts and cache metrics.
  - ✅ Hardened RBAC manifests.
  - ✅ Ray Serve HTTP integration with circuit breaking plus MNTP trainer support for LoRA and curated adapters.
  - ✅ Extend Alembic migrations for the newest SQLModel tables, including legacy tables created outside the current ORM layer.
  - ✅ Expose Ray Serve success/failure counters via OpenTelemetry (`llm.ray.*` metrics emitted by `LLMIntegration`).
- **Networking & Collaboration**
  - ✅ Encrypted peer registry, admin-guarded endpoints, and distributed scheduler.
  - ✅ Sommeil Paradoxal idle-time optimisation and safe apply pipeline.
  - ✅ Implemented load-aware scheduling strategies and shared optimisation telemetry across nodes.
- **Self-Improvement & Research**
  - ✅ Personality profiles persisted via SQLModel with live adapter updates.
  - ✅ Self-training cycles produce real adapter artefacts via `modules.neurons.training.mntp_trainer.MNTPTrainer` with deterministic fallbacks.
  - ✅ Reinforcement-learning research loops run through the evolution orchestrator, operator approvals, and long-haul validator with telemetry and manifest updates.【F:modules/evolution_engine/orchestrator.py†L360-L440】【F:monGARS/core/long_haul_validation.py†L1-L220】
  - ✅ ResearchLongHaulService now schedules multi-replica soak runs and persists observability snapshots for dashboards, ensuring reinforcement pipelines stay healthy without manual triggers.【F:monGARS/core/research_validation.py†L1-L200】【F:monGARS/core/reinforcement_observability.py†L1-L168】【F:tests/test_research_long_haul_service.py†L1-L200】【F:tests/test_long_haul_validation.py†L200-L320】

## Dependency & Configuration Discipline

- Resolve configuration once with `monGARS.config.get_settings()` and pass dependencies into constructors or FastAPI
    dependency overrides instead of storing module-level state.
- Guard optional integrations (Ray Serve, Torch, MLflow, Ollama) with capability checks and fall back to deterministic
    adapters (`AdaptiveResponseGenerator`, linear manifest paths) when unavailable.
- Coordinate shared singletons like `ui_events.event_bus`, cache layers, and rate limiters through the central
    `monGARS.core` modules so API routes, workers, and background schedulers stay in sync.

## Logging & Persistence

- Emit logs via `logging.getLogger(__name__)` with structured `extra` metadata; propagate correlation IDs surfaced by API
    and peer events.
- Route database access through `core.persistence.PersistenceRepository` and keep Alembic migrations in
    `alembic_migrations/` authoritative for schema changes.
- Use caching helpers in `core.caching` / `core.hippocampus` and ensure tests clear caches via fixtures to avoid state
    bleed.

## Testing Map

Update cognition, persistence, and networking suites together—`tests/test_conversation_flow.py`,
`tests/test_llm_integration.py`, `tests/test_peer_communication.py`, `tests/test_long_haul_validation.py`,
`tests/test_sustainability_dashboard.py`, and `tests/test_research_long_haul_service.py` exercise this package.

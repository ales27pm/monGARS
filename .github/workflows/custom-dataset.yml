name: Build Custom Québec-French Dataset

on:
  push:
    branches: ['**']
  workflow_dispatch:
    inputs:
      ratios:
        description: "Sampling ratios (sum≈1), e.g. frca:0.50,agent:0.40,repo:0.10"
        type: string
        default: "frca:0.50,agent:0.40,repo:0.10"
      val_pct:
        description: "Validation split percentage"
        type: number
        default: 0.06
      strict_qc:
        description: "Strict fr-CA filter (drop non-Québécois unless agent/internal)"
        type: boolean
        default: true
      retention_days:
        description: "Artifact retention (days)"
        type: number
        default: 14

permissions:
  contents: read

env:
  PYTHON_VERSION: "3.12"
  SCAN_OUTPUT_DIR: data/deep_scan
  FINAL_OUTPUT_DIR: data/final
  DATASET_RATIOS: ${{ github.event.inputs.ratios || 'frca:0.50,agent:0.40,repo:0.10' }}
  DATASET_VAL_PCT: ${{ github.event.inputs.val_pct || 0.06 }}
  DATASET_STRICT_QC: ${{ github.event.inputs.strict_qc || 'true' }}
  DATASET_RETENTION_DAYS: ${{ github.event.inputs.retention_days || 14 }}

concurrency:
  group: custom-dataset-${{ github.ref }}
  cancel-in-progress: true

jobs:
  curate:
    name: Curate Québec-French dataset
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip downloads
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ env.PYTHON_VERSION }}-${{ hashFiles('tools/monGARS_deep_scan/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ env.PYTHON_VERSION }}-
            ${{ runner.os }}-pip-

      - name: Install dataset tooling
        run: |
          python -m pip install --upgrade pip
          pip install -r tools/monGARS_deep_scan/requirements.txt

      - name: Execute deep scan pipeline
        env:
          PYTHONPATH: .
        run: |
          set -euxo pipefail
          python -m tools.monGARS_deep_scan.deep_scan \
            --input . \
            --out "${SCAN_OUTPUT_DIR}" \
            --exclude-dir "${SCAN_OUTPUT_DIR},${FINAL_OUTPUT_DIR},.git" \
            --jobs 4
          ls "${SCAN_OUTPUT_DIR}"

      - name: Build train/validation splits
        env:
          PYTHONPATH: .
        run: |
          python -m tools.monGARS_deep_scan.build_dataset

      - name: Publish dataset summary
        env:
          PYTHONPATH: .
        run: |
          python -m tools.monGARS_deep_scan.publish_summary --final-dir "${FINAL_OUTPUT_DIR}" --output summary.md
          cat summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: Upload dataset artefacts
        uses: actions/upload-artifact@v4
        with:
          name: custom-quebec-french-dataset
          path: |
            ${SCAN_OUTPUT_DIR}/sft_dataset.jsonl
            ${SCAN_OUTPUT_DIR}/agent_handoff_dataset.jsonl
            ${SCAN_OUTPUT_DIR}/embeddings_corpus.jsonl
            ${SCAN_OUTPUT_DIR}/provenance.csv
            ${SCAN_OUTPUT_DIR}/report.md
            ${SCAN_OUTPUT_DIR}/logs/**
            ${FINAL_OUTPUT_DIR}/train.jsonl
            ${FINAL_OUTPUT_DIR}/val.jsonl
            ${FINAL_OUTPUT_DIR}/dataset_summary.json
          retention-days: ${{ env.DATASET_RETENTION_DAYS }}
          if-no-files-found: error

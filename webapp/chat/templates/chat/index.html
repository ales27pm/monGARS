<!doctype html>
<html lang="fr-CA">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>monGARS - Interface de Chat</title>
    {% load static %}
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{% static 'css/chat.css' %}" />
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">monGARS Chat</a>
        <button
          type="button"
          class="btn btn-outline-light ms-auto"
          id="toggle-dark-mode"
          aria-pressed="false"
        >
          Mode Sombre
        </button>
      </div>
    </nav>
    <div class="container mt-4">
      <div class="row">
        <div class="col-lg-10 col-xl-8 offset-lg-1">
          {% if flash_message %}
          <div class="alert alert-success" role="status">
            {{ flash_message }}
          </div>
          {% endif %}
          <section
            id="connection"
            class="alert alert-info visually-hidden"
            role="status"
            aria-live="polite"
          ></section>
          <main id="chat" class="card shadow-sm">
            <header class="card-header border-0 bg-transparent pb-0">
              <div
                class="d-flex flex-column flex-md-row justify-content-between gap-2"
              >
                <div>
                  <h1 class="h5 mb-1">Historique du Chat</h1>
                  <p class="text-muted small mb-0">
                    Suivez les échanges et l'état de la connexion en temps réel.
                  </p>
                </div>
                <span
                  id="ws-status"
                  class="badge ws-badge offline align-self-start align-self-md-center"
                  aria-live="polite"
                  >Hors ligne</span
                >
              </div>
              <p
                id="connection-meta"
                class="small text-muted mb-0 mt-2"
                aria-live="polite"
              >
                En attente de connexion…
              </p>
              <section
                id="connection-diagnostics"
                class="connection-diagnostics mt-3"
                aria-live="polite"
                aria-label="Diagnostics de connexion"
              >
                <dl class="connection-diagnostics-list">
                  <div class="connection-diagnostics-item">
                    <dt>Connecté depuis</dt>
                    <dd id="diag-connected">—</dd>
                  </div>
                  <div class="connection-diagnostics-item">
                    <dt>Dernier message</dt>
                    <dd id="diag-last-message">—</dd>
                  </div>
                  <div class="connection-diagnostics-item">
                    <dt>Latence</dt>
                    <dd id="diag-latency">—</dd>
                  </div>
                  <div class="connection-diagnostics-item">
                    <dt>Réseau</dt>
                    <dd id="diag-network">Vérification…</dd>
                  </div>
                </dl>
              </section>
            </header>
            <div class="card-body p-0">
              <div class="chat-wrapper">
                <div
                  id="transcript"
                  class="chat-transcript"
                  aria-live="polite"
                  aria-busy="false"
                >
                  {% if history_error %}
                  <div class="chat-row chat-system">
                    <div class="chat-bubble chat-bubble-error">
                      {{ history_error }}
                    </div>
                  </div>
                  {% endif %} {% for item in history %} {% if item.query %}
                  <div class="chat-row chat-user">
                    <div class="chat-bubble">
                      {{ item.query }}
                      <div class="chat-meta">
                        {{ item.timestamp|default_if_none:"" }}
                      </div>
                    </div>
                  </div>
                  {% endif %} {% if item.response %}
                  <div class="chat-row chat-assistant">
                    <div class="chat-bubble">
                      {{ item.response }}
                      <div class="chat-meta">
                        {{ item.timestamp|default_if_none:"" }}
                      </div>
                    </div>
                  </div>
                  {% endif %} {% empty %} {% if not history_error %}
                  <div class="chat-row chat-system">
                    <div class="chat-bubble chat-bubble-hint">
                      Aucun échange pour le moment.
                    </div>
                  </div>
                  {% endif %} {% endfor %}
                </div>
                <p
                  id="filter-empty"
                  class="text-muted small text-center py-3 d-none"
                  role="status"
                  aria-live="polite"
                >
                  Aucun message ne correspond à votre filtre.
                </p>
                <button
                  type="button"
                  id="scroll-bottom"
                  class="btn btn-outline-secondary btn-sm scroll-bottom d-none"
                  aria-hidden="true"
                >
                  Dernier message
                </button>
              </div>
              <div
                id="error-alert"
                class="alert alert-danger m-3 d-none alert-dismissible fade show"
                role="alert"
              >
                <span id="error-message"></span>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="alert"
                  aria-label="Fermer"
                ></button>
              </div>
              <aside id="actions" class="chat-actions px-3 pb-3">
                <div class="chat-actions-toolbar mb-3">
                  <div class="input-group input-group-sm chat-filter">
                    <span class="input-group-text" id="chat-search-label"
                      >Filtrer</span
                    >
                    <input
                      type="search"
                      id="chat-search"
                      class="form-control"
                      placeholder="Rechercher dans la conversation"
                      aria-describedby="chat-search-label chat-search-hint"
                    />
                    <button
                      type="button"
                      class="btn btn-outline-secondary"
                      id="chat-search-clear"
                    >
                      Effacer
                    </button>
                  </div>
                  <p
                    id="chat-search-hint"
                    class="form-text small text-muted mb-0 mt-2"
                  >
                    Utilisez le filtre pour limiter l'historique. Appuyez sur
                    Échap pour effacer.
                  </p>
                  <div class="btn-toolbar mt-3" role="toolbar">
                    <div class="btn-group btn-group-sm me-2" role="group">
                      <button
                        type="button"
                        class="btn btn-outline-primary"
                        id="export-json"
                      >
                        Export JSON
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-primary"
                        id="export-markdown"
                      >
                        Export Markdown
                      </button>
                    </div>
                    <button
                      type="button"
                      class="btn btn-outline-secondary btn-sm"
                      id="export-copy"
                    >
                      Copier la conversation
                    </button>
                  </div>
                  <p
                    class="form-text small text-muted mb-0 mt-2"
                    id="export-hint"
                  >
                    Les exports incluent l'ensemble des messages, même ceux qui
                    ne sont plus visibles.
                  </p>
                </div>
                <div
                  class="chat-actions-row"
                  id="quick-actions"
                  role="list"
                  aria-label="Suggestions rapides"
                >
                  <button
                    type="button"
                    role="listitem"
                    class="qa btn btn-outline-secondary"
                    data-action="summarize"
                  >
                    Résumer
                  </button>
                  <button
                    type="button"
                    role="listitem"
                    class="qa btn btn-outline-secondary"
                    data-action="code"
                  >
                    Code
                  </button>
                  <button
                    type="button"
                    role="listitem"
                    class="qa btn btn-outline-secondary"
                    data-action="explain"
                  >
                    Expliquer
                  </button>
                </div>
              </aside>
              <form
                id="composer"
                class="p-3 border-top"
                autocomplete="off"
                method="post"
                novalidate
              >
                {% csrf_token %} {% if form_error %}
                <div class="alert alert-warning" role="alert">
                  {{ form_error }}
                </div>
                {% endif %}
                <div class="input-group">
                  <textarea
                    id="prompt"
                    name="prompt"
                    class="form-control"
                    placeholder="Entrez votre message…"
                    autocomplete="off"
                    rows="1"
                    maxlength="1000"
                    aria-label="Message à envoyer"
                    data-embed-placeholder="Entrez le texte à encoder…"
                    data-embed-aria-label="Texte à encoder"
                    aria-describedby="composer-hint"
                  >
                  {{ prompt_value|default_if_none:"" }}
                  </textarea>
                  <button
                    id="send"
                    type="submit"
                    class="btn btn-primary"
                    data-idle-label="Envoyer"
                    data-embed-aria-label="Générer un embedding"
                  >
                    Envoyer
                  </button>
                </div>
                <div
                  class="composer-meta form-text d-flex justify-content-between flex-wrap gap-2 mt-2"
                  id="composer-hint"
                >
                  <span
                    id="composer-status"
                    class="composer-status text-muted"
                    data-embed-label="Mode Embedding : générez des vecteurs pour vos textes."
                    >Appuyez sur Ctrl+Entrée pour envoyer rapidement.</span
                  >
                  <div class="chat-mode-toggle d-flex align-items-center gap-2">
                    <label class="mb-0 small" for="chat-mode">Mode</label>
                    <select
                      id="chat-mode"
                      class="form-select form-select-sm w-auto"
                      aria-label="Sélection du mode de requête"
                    >
                      <option value="chat" selected>Chat</option>
                      <option value="embed">Embedding</option>
                    </select>
                  </div>
                  <span
                    id="prompt-count"
                    class="composer-count text-muted"
                    data-max="1000"
                    >0 / 1000</span
                  >
                </div>
                <div
                  class="voice-controls mt-3"
                  id="voice-controls"
                  aria-live="polite"
                  aria-label="Contrôles vocaux"
                >
                  <div id="voice-recognition-group" class="voice-section">
                    <div class="d-flex flex-wrap align-items-center gap-2">
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm"
                        id="voice-toggle"
                        aria-pressed="false"
                        disabled
                      >
                        🎙️ Activer la dictée
                      </button>
                      <div class="form-check form-switch m-0">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="voice-auto-send"
                        />
                        <label class="form-check-label" for="voice-auto-send">
                          Envoyer automatiquement
                        </label>
                      </div>
                    </div>
                  </div>
                  <div id="voice-synthesis-group" class="voice-section mt-2">
                    <div class="d-flex flex-wrap align-items-center gap-2">
                      <div class="form-check form-switch m-0">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="voice-playback"
                        />
                        <label class="form-check-label" for="voice-playback">
                          Lire les réponses
                        </label>
                      </div>
                      <label
                        class="form-label mb-0 small"
                        for="voice-voice-select"
                      >
                        Voix
                      </label>
                      <select
                        id="voice-voice-select"
                        class="form-select form-select-sm voice-select"
                      ></select>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm"
                        id="voice-stop-playback"
                        disabled
                      >
                        🔇 Couper la lecture
                      </button>
                      <span
                        id="voice-speaking-indicator"
                        class="badge bg-secondary d-none"
                      >
                        Lecture…
                      </span>
                    </div>
                  </div>
                  <p class="small text-muted mb-1 mt-2" id="voice-status">
                    Vérification des capacités vocales…
                  </p>
                  <output
                    id="voice-transcript"
                    class="voice-transcript form-text text-muted"
                    aria-live="polite"
                  ></output>
                </div>
              </form>
            </div>
          </main>
        </div>
      </div>
    </div>
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    {{ history_json|json_script:"chat-history" }}
    <script>
      window.chatConfig = {
        fastapiUrl: "{{ fastapi_url }}",
        embedServiceUrl: {% if embed_service_url %}"{{ embed_service_url|escapejs }}"{% else %}null{% endif %},
        userId: "{{ user_id }}",
        token: "{{ token }}",
      };
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="{% static 'js/chat.js' %}"></script>
  </body>
</html>
